# lima vm configuration
# ubuntu vm with gemini cli, repository and ssh access
vmType: "vz"
arch: "aarch64"

images:
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"

cpus: 2
memory: "3GiB"

user:
  name: "${VM_USER}"

mounts:
- location: "${PATH_LIMA_SSH}"
  mountPoint: "/tmp/ssh"
  writable: false
- location: "${PATH_REPOSITORY}"
  mountPoint: "/tmp/repository"
  writable: true
- location: "${PATH_LIMA_GEMINI}/"
  mountPoint: "/home/${VM_USER}.linux/.gemini"
  writable: true

ssh:
  localPort: ${VM_SSH_PORT}
  loadDotSSHPubKeys: false

provision:
- mode: system
  script: |
    # 1. System Check: Exit immediately if already initialized
    if [ -f "/etc/.lima_system_init_done" ]; then
      exit 0
    fi

    # 2. System Setup: Packages, Sudoers, and Init Password
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get update
    apt-get install -y git curl nodejs
    npm install -g @google/gemini-cli

    cat <<EOF > /etc/sudoers.d/90-lima-user
    ${VM_USER} ALL=(ALL) PASSWD: ALL
    ${VM_USER} ALL=(ALL) NOPASSWD: /usr/bin/cat /mnt/lima-cidata/param.env, /usr/bin/diff -q /run/lima-boot-done /mnt/lima-cidata/meta-data
    EOF
    chmod 440 /etc/sudoers.d/90-lima-user

    echo "${VM_USER}:${VM_INIT_PASS}" | chpasswd

    # 3. Mark system init as complete
    touch /etc/.lima_system_init_done

- mode: user
  script: |
    # 1. User Check: Exit immediately if already initialized
    if [ -f "~/.lima_user_init_done" ]; then
      exit 0
    fi

    # 2. User Setup: SSH Keys and Profile
    # Using ~ instead of $HOME makes it invisible to Mac's envsubst
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
    
    if [ -f "/tmp/ssh/key.pub" ]; then
      cat "/tmp/ssh/key.pub" >> ~/.ssh/authorized_keys
      chmod 600 ~/.ssh/authorized_keys
    else
      echo "Error: SSH key not found" >&2
      exit 1
    fi

    echo "export GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}" >> ~/.profile
    echo "alias cdr='cd /tmp/repository/'" >> ~/.profile
    echo "export GEMINI_SYSTEM_MD='~/.gemini/system-instructions.md'" >> ~/.profile

    # 3. Mark user init as complete
    touch ~/.lima_user_init_done

hostResolver:
  hosts:
    host.docker.internal: host.lima.internal