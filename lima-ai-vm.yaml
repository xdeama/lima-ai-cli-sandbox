# lima vm configuration
vmType: "vz"
arch: "aarch64"
images:
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"
cpus: 2
memory: "8GiB"
user:
  name: "${VM_USER}"
mounts:
- location: "${PATH_LIMA_SSH}"
  mountPoint: "/tmp/ssh"
  writable: false
- location: "${PATH_REPOSITORY}"
  mountPoint: "/mnt/repository"
  writable: true
- location: "${PATH_LIMA_CLAUDE}/"
  mountPoint: "/home/${VM_USER}.linux/.claude"
  writable: true
- location: "${PATH_LIMA_GEMINI}/"
  mountPoint: "/home/${VM_USER}.linux/.gemini"
  writable: true
ssh:
  localPort: ${VM_SSH_PORT}
  loadDotSSHPubKeys: false
provision:
# --- System Setup: Update Linux ---
- mode: system
  script: |
    if [ -f "/etc/.lima_system_init_done" ]; then
      exit 0
    fi

    apt-get update

    touch /etc/.lima_system_init_done

# --- Dev Tools Installation ---
- mode: system
  script: |
    if [ -f "/etc/.lima_devtools_init_done" ]; then
      exit 0
    fi

    # NodeJS
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get install -y nodejs

    # AI CLI Tools
    npm install -g @anthropic-ai/claude-code
    npm install -g @google/gemini-cli

    # Java
    apt-get install -y git curl openjdk-21-jdk

    # Docker for MCP servers
    apt-get install -y docker.io
    groupadd -f docker
    usermod -aG docker {{.User}}

    touch /etc/.lima_devtools_init_done

# --- Security Hardening: Sudo password (must run after all other system blocks) ---
- mode: system
  script: |
    if [ -f "/etc/.lima_sudo_init_done" ]; then
      exit 0
    fi

    cat <<EOF > /etc/sudoers.d/90-lima-user
    ${VM_USER} ALL=(ALL) PASSWD: ALL
    ${VM_USER} ALL=(ALL) NOPASSWD: /usr/bin/cat /mnt/lima-cidata/param.env, /usr/bin/diff -q /run/lima-boot-done /mnt/lima-cidata/meta-data
    EOF
    chmod 440 /etc/sudoers.d/90-lima-user
    echo "${VM_USER}:${VM_INIT_PASS}" | chpasswd

    touch /etc/.lima_sudo_init_done

# --- User Setup: SSH keys, profile, and symlinks ---
- mode: user
  script: |
    # Always run: symlink .claude.json from inside the persistent mount
    # On host, store the file as $PATH_LIMA_CLAUDE/.claude.json
    ln -sfn ~/.claude/.claude.json ~/.claude.json

    if [ -f "~/.lima_user_init_done" ]; then
      exit 0
    fi

    # Using ~ instead of $HOME to avoid replacement by envsubst, which is used to substitute the variables from .env
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh
    if [ -f "/tmp/ssh/key.pub" ]; then
      cat "/tmp/ssh/key.pub" >> ~/.ssh/authorized_keys
      chmod 600 ~/.ssh/authorized_keys
    else
      echo "Error: SSH key not found" >&2
      exit 1x 
    fi

    echo "export SONARQUBE_TOKEN=${SONARQUBE_TOKEN}" >> ~/.profile
    echo "export SONARQUBE_URL=${SONARQUBE_URL}" >> ~/.profile
    echo "alias cdr='cd /mnt/repository'" >> ~/.profile
    echo "export GOOGLE_CLOUD_PROJECT=${GCP_PROJECT_ID}" >> ~/.profile

    touch ~/.lima_user_init_done
hostResolver:
  hosts:
    host.docker.internal: host.lima.internal