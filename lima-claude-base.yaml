# lima vm configuration
# ubuntu vm with claude code, repository and ssh access
# base template - add project-specific tooling on top of this
vmType: "vz"
arch: "aarch64"

images:
- location: "https://cloud-images.ubuntu.com/releases/24.04/release/ubuntu-24.04-server-cloudimg-arm64.img"

cpus: 2
memory: "4GiB"

user:
  name: "${VM_USER}"

mounts:
- location: "${PATH_LIMA_SSH}"
  mountPoint: "/tmp/ssh"
  writable: false
- location: "${PATH_REPOSITORY}"
  mountPoint: "/mnt/repository"
  writable: true
- location: "${PATH_LIMA_CLAUDE}/"
  mountPoint: "/home/${VM_USER}.linux/.claude"
  writable: true

ssh:
  localPort: ${VM_SSH_PORT}
  loadDotSSHPubKeys: false

provision:
- mode: system
  script: |
    # 1. System Check: Exit immediately if already initialized
    if [ -f "/etc/.lima_system_init_done" ]; then
      exit 0
    fi

    # 2. System Setup: Packages and Claude Code
    curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    apt-get update
    apt-get install -y git
    apt-get install -y curl
    apt-get install -y nodejs
    apt-get install -y docker.io

    npm install -g @anthropic-ai/claude-code

    # 3. Mark system init as complete
    touch /etc/.lima_system_init_done

- mode: user
  script: |
    # Always run: symlink .claude.json from inside the persistent mount
    # On host, store the file as $PATH_LIMA_CLAUDE/.claude.json
    ln -sfn ~/.claude/.claude.json ~/.claude.json

    # 1. User Check: Exit immediately if already initialized
    if [ -f "~/.lima_user_init_done" ]; then
      exit 0
    fi

    # 2. User Setup: SSH Keys and Profile
    # Using ~ instead of $HOME makes it invisible to Mac's envsubst
    mkdir -p ~/.ssh
    chmod 700 ~/.ssh

    if [ -f "/tmp/ssh/key.pub" ]; then
      cat "/tmp/ssh/key.pub" >> ~/.ssh/authorized_keys
      chmod 600 ~/.ssh/authorized_keys
    else
      echo "Error: SSH key not found" >&2
      exit 1
    fi

    echo "export SONARQUBE_TOKEN=${SONARQUBE_TOKEN}" >> ~/.profile
    echo "export SONARQUBE_URL=${SONARQUBE_URL}" >> ~/.profile

    # 3. Mark user init as complete
    touch ~/.lima_user_init_done

hostResolver:
  hosts:
    host.docker.internal: host.lima.internal
